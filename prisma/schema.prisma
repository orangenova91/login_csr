// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model User {
  id             String    @id @default(auto()) @map("_id") @db.ObjectId
  email          String    @unique
  hashedPassword String? // OAuth 사용자는 비밀번호가 없을 수 있음
  name           String?
  school         String?
  role           String? // "student", "teacher", "admin", 또는 "superadmin"
  emailVerified  DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Password reset
  resetPasswordToken   String?
  resetPasswordExpires DateTime?

  // Email verification
  verificationToken   String?
  verificationExpires DateTime?

  // Relations
  accounts       Account[]
  sessions       Session[]
  classes        Course[]        @relation("TeacherCourses")
  studentProfile StudentProfile?
  teacherProfile TeacherProfile?
  adminProfile   AdminProfile?
  createdSchools School[]        @relation("SchoolCreator") // 슈퍼어드민이 생성한 학교
  adminSchools   School[]        @relation("SchoolAdminUser") // Admin이 담당하는 학교

  @@map("users")
}

model Account {
  id                String  @id @default(auto()) @map("_id") @db.ObjectId
  userId            String  @db.ObjectId
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  sessionToken String   @unique
  userId       String   @db.ObjectId
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model Course {
  id                  String               @id @default(auto()) @map("_id") @db.ObjectId
  academicYear        String               @default("")
  semester            String               @default("")
  subjectGroup        String               @default("")
  subjectArea         String               @default("")
  careerTrack         String               @default("")
  subject             String
  grade               String
  instructor          String
  classroom           String
  description         String               @default("")
  joinCode            String?
  teacherId           String?              @db.ObjectId
  teacher             User?                @relation("TeacherCourses", fields: [teacherId], references: [id], onDelete: SetNull)
  assignments         Assignment[]
  evaluationQuestions EvaluationQuestion[]
  classGroups         ClassGroup[]
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt

  @@map("classes")
}

model Assignment {
  id               String                 @id @default(auto()) @map("_id") @db.ObjectId
  title            String
  description      String?
  filePath         String? // 서버에 저장된 파일 경로
  originalFileName String? // 원본 파일명
  fileSize         Int? // 파일 크기 (bytes)
  mimeType         String? // 파일 MIME 타입
  dueDate          DateTime? // 마감일 (선택적)
  courseId         String                 @db.ObjectId
  course           Course                 @relation(fields: [courseId], references: [id], onDelete: Cascade)
  teacherId        String                 @db.ObjectId
  createdAt        DateTime               @default(now())
  updatedAt        DateTime               @updatedAt
  attachments      AssignmentAttachment[] // 다중 첨부파일

  @@map("assignments")
}

model AssignmentAttachment {
  id               String     @id @default(auto()) @map("_id") @db.ObjectId
  assignmentId     String     @db.ObjectId
  assignment       Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  filePath         String
  originalFileName String
  fileSize         Int?
  mimeType         String?
  createdAt        DateTime   @default(now())

  @@map("assignment_attachments")
}

model EvaluationQuestion {
  id             String   @id @default(auto()) @map("_id") @db.ObjectId
  unit           String // 평가 단원
  questionNumber String // 문제 주문번호
  questions      String // JSON 배열로 저장된 문항들
  courseId       String   @db.ObjectId
  course         Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  teacherId      String   @db.ObjectId
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@map("evaluation_questions")
}

model ClassGroup {
  id          String       @id @default(auto()) @map("_id") @db.ObjectId
  name        String // 학반명
  period      String? // 차시
  schedules   String // JSON 배열로 저장된 스케줄 (요일과 교시)
  courseId    String       @db.ObjectId
  course      Course       @relation(fields: [courseId], references: [id], onDelete: Cascade)
  studentIds  String[] // 학생 ID 배열
  teacherId   String       @db.ObjectId
  attendances Attendance[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@map("class_groups")
}

model Attendance {
  id           String     @id @default(auto()) @map("_id") @db.ObjectId
  classGroupId String     @db.ObjectId
  classGroup   ClassGroup @relation(fields: [classGroupId], references: [id], onDelete: Cascade)
  studentId    String     @db.ObjectId
  date         DateTime // 출결 날짜
  status       String // 출결 상태: "present", "late", "sick_leave", "approved_absence", "excused"
  teacherId    String     @db.ObjectId
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@unique([classGroupId, studentId, date])
  @@map("attendances")
}

model StudentProfile {
  id                         String   @id @default(auto()) @map("_id") @db.ObjectId
  userId                     String   @unique @db.ObjectId
  user                       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  studentId                  String?
  school                     String?
  grade                      String?
  classLabel                 String?
  section                    String?
  seatNumber                 String?
  major                      String?
  sex                        String?
  classOfficer               String?
  specialEducation           String?
  phoneNumber                String?
  siblings                   String?
  academicStatus             String?
  remarks                    String?
  club                       String?
  clubTeacher                String?
  clubLocation               String?
  dateOfBirth                String?
  address                    String?
  residentRegistrationNumber String?
  motherName                 String?
  motherPhone                String?
  motherRemarks              String?
  fatherName                 String?
  fatherPhone                String?
  fatherRemarks              String?
  electiveSubjects           String[]
  createdAt                  DateTime @default(now())
  updatedAt                  DateTime @updatedAt

  @@map("student_profiles")
}

model TeacherProfile {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  userId       String   @unique @db.ObjectId
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  school       String?
  roleLabel    String?
  major        String?
  classLabel   String?
  grade        String?
  section      String?
  phoneNumber  String?
  remarks      String?
  club         String?
  clubLocation String?
  dateOfBirth  String?
  address      String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("teacher_profiles")
}

model CalendarEvent {
  id               String   @id @default(auto()) @map("_id") @db.ObjectId
  title            String
  description      String?
  startDate        DateTime
  endDate          DateTime?
  eventType        String   // "평가", "행사", "휴업일", "개인일정", "기타"
  scope            String   // "school" | "personal" | "class"
  school           String?  // scope가 "school"일 때 학교 필터링
  teacherId        String?  @db.ObjectId // 개인일정일 때
  courseId         String?  @db.ObjectId // 수업별 일정일 때
  department        String?   // 담당 부서
  responsiblePerson String?   // 담당자
  gradeLevels       String[] @default([])
  periods           String[]  @default([])
  createdBy        String   @db.ObjectId // 생성한 사용자 ID
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@map("calendar_events")
  @@index([scope, school])
  @@index([teacherId])
  @@index([startDate])
}

model Announcement {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  content     String   // HTML 형식의 본문
  audience    String   // "all", "grade-1", "grade-2", "grade-3", "parents", "teachers"
  author      String   // 작성자 이름
  authorId    String   @db.ObjectId // 작성자 User ID
  isScheduled Boolean  @default(false)
  publishAt   DateTime? // 예약 발행 시각
  publishedAt DateTime? // 실제 발행 시각
  school      String?  // 학교 필터링
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("announcements")
  @@index([audience])
  @@index([authorId])
  @@index([publishAt])
  @@index([publishedAt])
}

model School {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  name            String   @unique // 학교 이름
  adminUserId     String   @db.ObjectId // 담당 Admin 계정 ID
  admin           User     @relation("SchoolAdminUser", fields: [adminUserId], references: [id], onDelete: Cascade)
  createdBy       String?  @db.ObjectId // 생성한 슈퍼어드민 ID
  creator         User?    @relation("SchoolCreator", fields: [createdBy], references: [id], onDelete: SetNull)
  adminProfiles   AdminProfile[] // AdminProfile과의 관계
  
  // 학교 구분
  schoolType      String   @default("기타") // "초등학교", "중학교", "고등학교", "대학교", "기타"
  
  // 담당자 정보
  contactName     String   // 스쿨허브 담당자 이름
  contactPhone    String   // 담당자 전화번호
  
  // 학교 규모 정보 (학년별 학급수 및 총 학생수)
  gradeInfo       String   // JSON 형식: [{grade: "1", classCount: 5, studentCount: 150}, ...]
  totalClasses    Int?     // 총 학급수 (계산된 값)
  totalStudents   Int?     // 총 학생수 (계산된 값)
  
  status          String   @default("active") // "active", "inactive", "suspended"
  notes           String?  // 메모
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@map("schools")
  @@index([adminUserId])
  @@index([createdBy])
  @@index([status])
}

model AdminProfile {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  userId          String   @unique @db.ObjectId
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  schoolId        String?  @db.ObjectId
  school          School?  @relation(fields: [schoolId], references: [id], onDelete: SetNull)
  phoneNumber     String?
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@map("admin_profiles")
  @@index([schoolId])
}
